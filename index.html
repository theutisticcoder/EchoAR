<!DOCTYPE html>
<html>
<head>
    <title>AR Ruler</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-webxr-hit-test@1.0.0/dist/aframe-webxr-hit-test.min.js"></script>
</head>
<body>
    <a-scene webxr="requiredFeatures: hit-test;" ar-hit-test="doReticle: true;">
        <a-camera position="0 1.6 0"></a-camera>

        <a-sphere id="point1" radius="0.05" color="blue" visible="false"></a-sphere>
        <a-sphere id="point2" radius="0.05" color="red" visible="false"></a-sphere>
        <a-entity id="measurementLine" line="start: 0 0 0; end: 0 0 0; color: green; opacity: 0.8;" visible="false"></a-entity>
        <a-text id="distanceText" value="" position="0 0.2 0" align="center" color="white" scale="0.5 0.5 0.5" visible="false"></a-text>

        <script>
            let firstPointSet = false;
            let point1Pos = new THREE.Vector3();
            let point2Pos = new THREE.Vector3();

            const scene = document.querySelector('a-scene');
            const point1El = document.getElementById('point1');
            const point2El = document.getElementById('point2');
            const measurementLineEl = document.getElementById('measurementLine');
            const distanceTextEl = document.getElementById('distanceText');

            scene.addEventListener('ar-hit-test-select', function (event) {
                if (event.detail.results.length > 0) {
                    const hitResult = event.detail.results[0];
                    const hitPose = new THREE.Matrix4().fromArray(hitResult.pose.transform.matrix);
                    const hitPosition = new THREE.Vector3().setFromMatrixPosition(hitPose);

                    if (!firstPointSet) {
                        point1Pos.copy(hitPosition);
                        point1El.setAttribute('position', hitPosition);
                        point1El.setAttribute('visible', true);
                        firstPointSet = true;
                        distanceTextEl.setAttribute('value', 'Set second point...');
                        distanceTextEl.setAttribute('visible', true);
                    } else {
                        point2Pos.copy(hitPosition);
                        point2El.setAttribute('position', hitPosition);
                        point2El.setAttribute('visible', true);

                        const distance = point1Pos.distanceTo(point2Pos);
                        distanceTextEl.setAttribute('value', `${distance.toFixed(2)} meters`);

                        // Position the text mid-way between the points, slightly above
                        const midPoint = new THREE.Vector3().addVectors(point1Pos, point2Pos).multiplyScalar(0.5);
                        midPoint.y += 0.2; // Lift the text slightly
                        distanceTextEl.setAttribute('position', midPoint);
                        
                        // Update line
                        measurementLineEl.setAttribute('line', `start: ${point1Pos.x} ${point1Pos.y} ${point1Pos.z}; end: ${point2Pos.x} ${point2Pos.y} ${point2Pos.z}; color: green; opacity: 0.8;`);
                        measurementLineEl.setAttribute('visible', true);

                        firstPointSet = false; // Reset for next measurement
                    }
                }
            });

            // Optional: Reset button for convenience
            document.addEventListener('keydown', (event) => {
                if (event.key === 'r' || event.key === 'R') {
                    firstPointSet = false;
                    point1El.setAttribute('visible', false);
                    point2El.setAttribute('visible', false);
                    measurementLineEl.setAttribute('visible', false);
                    distanceTextEl.setAttribute('visible', false);
                    distanceTextEl.setAttribute('value', '');
                }
            });

        </script>
    </a-scene>
</body>
</html>
